# Project/MCU configuration
NAME:=$(shell basename "$(PWD)")
MCU:=atmega328p
BOARD:=ARDUINO_AVR_UNO
F_CPU:=16000000
SRCS:=$(shell find . -name "*.c")
PORT:=/dev/ttyUSB0

# Library
LIBRARY_CFLAGS:=-I../../include -L../.. -lminiavr

# Autogenerated
DEPS:=$(SRCS:.c=.o)
BIN:=$(NAME).elf
HEX:=$(BIN:.elf=.hex)

# Toolchain
CC:=avr-gcc
OBJCOPY:=avr-objcopy

# AVRdude settings
PROGRAMMER:=arduino
PARTNO:=$(MCU)

include ../../board.inc

CFLAGS:=-mmcu=$(MCU) -D$(BOARD) -DF_CPU=$(F_CPU) -Os

.PHONY all: checklibrary $(HEX)

checklibrary:
	if [ ! -f "../../libminiavr.a" ]; then echo "Please compile libminiavr by running make in the root first!"; exit 1; fi

%.o: %.c
	$(CC) $(CFLAGS) -o $@ -c $< $(LIBRARY_CFLAGS)

$(BIN): $(DEPS)
	$(CC) $(CFLAGS) $(DEPS) -o $@ $(LIBRARY_CFLAGS)

$(HEX): $(BIN)
	$(OBJCOPY) -R .eeprom -O ihex $< $@

upload: $(HEX)
	avrdude -c $(PROGRAMMER) -p $(PARTNO) -P $(PORT) $(AVRDUDE_EXTRA) -U flash:w:$<

clean:
	rm -f $(DEPS)
	rm -f $(BIN)
	rm -f $(HEX)
